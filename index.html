<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Optimized Map Prototype</title>
  <!-- Mobile-friendly viewport tag -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    /* Player marker blinking animation (disabled on small screens) */
    @media (max-width: 768px) {
      .blinking-circle {
        animation: none;
        background: rgba(0, 0, 255, 1);
      }
    }
    .blinking-circle {
      width: 12px;
      height: 12px;
      background: rgba(0, 0, 255, 0.7);
      border: 2px solid white;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- MarkerCluster (optional for clustering spawn markers) -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    // Initialize the map using canvas for vector layers
    var map = L.map('map', {
      preferCanvas: true,
      center: [51.505, -0.09],
      zoom: 15,
      zoomAnimation: true
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // Create the player marker (with blinking circle) and its interaction radius circle
    var playerMarker = L.marker([51.505, -0.09], {
      icon: L.divIcon({
        className: '',
        html: '<div class="blinking-circle"></div>',
        iconSize: [12, 12],
        iconAnchor: [6, 6]
      })
    }).addTo(map);

    var interactionRadius = 115;
    var radiusCircle = L.circle([51.505, -0.09], {
      radius: interactionRadius,
      color: 'blue',
      fillOpacity: 0.2
    }).addTo(map);

    // Generate a random point within a given radius (in meters)
    function randomPointNear(lat, lng, radius) {
      var rd = radius / 111300;
      var u = Math.random();
      var v = Math.random();
      var w = rd * Math.sqrt(u);
      var t = 2 * Math.PI * v;
      var x = w * Math.cos(t);
      var y = w * Math.sin(t);
      var newX = x / Math.cos(lat * Math.PI / 180);
      return [lat + y, lng + newX];
    }

    // Update the player’s position only if movement exceeds a threshold (e.g., 5 meters)
    var lastUpdateTime = 0;
    var updateThreshold = 5; // in meters

    function updatePlayerLocation(newLat, newLng) {
      var currentPos = playerMarker.getLatLng();
      var distance = map.distance(currentPos, L.latLng(newLat, newLng));
      if (distance > updateThreshold) {
        playerMarker.setLatLng([newLat, newLng]);
        radiusCircle.setLatLng([newLat, newLng]);
      }
    }

    // Use requestAnimationFrame for smooth, throttled updates
    function simulateMovement(timestamp) {
      if (!lastUpdateTime) lastUpdateTime = timestamp;
      var elapsed = timestamp - lastUpdateTime;
      // Update at most every 1000ms (or longer if needed)
      if (elapsed > 1000) {
        var newPoint = randomPointNear(51.505, -0.09, 10);
        updatePlayerLocation(newPoint[0], newPoint[1]);
        lastUpdateTime = timestamp;
      }
      requestAnimationFrame(simulateMovement);
    }
    requestAnimationFrame(simulateMovement);

    // Level-of-detail: render spawn markers only if they are within current map bounds.
    // Generate sample spawn marker data
    var spawnMarkersData = [];
    for (var i = 0; i < 50; i++) {
      spawnMarkersData.push(randomPointNear(51.505, -0.09, interactionRadius));
    }

    var markersCluster = L.markerClusterGroup();
    function addVisibleSpawnMarkers() {
      markersCluster.clearLayers();
      var bounds = map.getBounds();
      spawnMarkersData.forEach(function(pt, index) {
        if (bounds.contains(pt)) {
          var marker = L.marker(pt).bindPopup("Spawn " + (index + 1));
          markersCluster.addLayer(marker);
        }
      });
      map.addLayer(markersCluster);
    }
    // Update spawn markers when the map stops moving
    map.on('moveend zoomend', addVisibleSpawnMarkers);
    addVisibleSpawnMarkers();
  </script>
</body>
</html>
