<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Leaflet: Dynamic Spawn Types</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    .blinking-circle {
      width: 12px;
      height: 12px;
      background: rgba(0, 0, 255, 0.7);
      border: 2px solid white;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.5; }
      100% { transform: scale(1); opacity: 1; }
    }
    .spawn-icon div {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .spawn-icon.creatures div { background: purple; }
    .spawn-icon.dungeons div { background: darkgray; }
    .spawn-icon.inns div { background: orange; }
    .spawn-icon.shops div { background: blue; }
    .spawn-icon.quests div { background: green; }
    .spawn-icon.keeps div { background: brown; }
    .spawn-icon.lairs div { background: black; }
    .blinking-zone {
      animation: blinkZone 2s infinite;
    }
    @keyframes blinkZone {
      0% { fill-opacity: 0.3; }
      50% { fill-opacity: 0.1; }
      100% { fill-opacity: 0.3; }
    }
    #debug-panel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      font-size: 12px;
      max-width: 300px;
      z-index: 1000;
      overflow: auto;
      max-height: 200px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="debug-panel">
    <strong>Debug Output:</strong>
    <pre id="debug-log"></pre>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    const spawnDataUrl = "spawnData.json";
    var lastPlayerLatLng = null;
    var spawnTypes = null;
    var markersCluster = L.markerClusterGroup();
    var initialCentered = false;
    var dynamicSpawnPoints = [];

    var map = L.map('map', { preferCanvas: true, zoomAnimation: true }).setView([51.505, -0.09], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    var playerMarker = L.marker([51.505, -0.09], {
      icon: L.divIcon({ className: '', html: '<div class="blinking-circle"></div>', iconSize: [12, 12], iconAnchor: [6, 6] })
    });

    var playerRadiusCircle = L.circle([], { color: 'green', fillOpacity: 0.2, radius: 229 });

    function logDebug(message) {
      const debugPanel = document.getElementById("debug-log");
      debugPanel.innerText += message + "\n";
      console.log(message);
    }

    function pickSpawnType() {
      if (!spawnTypes) return null;
      var totalRate = spawnTypes.reduce((acc, st) => acc + (st.spawnRate || 0), 0);
      var rnd = Math.random() * totalRate;
      var cumulative = 0;
      for (var i = 0; i < spawnTypes.length; i++) {
        cumulative += spawnTypes[i].spawnRate || 0;
        if (rnd <= cumulative) return spawnTypes[i];
      }
      return spawnTypes[spawnTypes.length - 1];
    }

    function generateDynamicSpawns(center) {
      dynamicSpawnPoints = [];
      for (var i = 0; i < 3; i++) {
        var numPoints = Math.floor(Math.random() * 3) + 3;
        for (var j = 0; j < numPoints; j++) {
          var r = 250 + Math.random() * 500;
          var angle = Math.random() * 2 * Math.PI;
          var dLat = r / 111300 * Math.cos(angle);
          var dLng = r / (111300 * Math.cos(center.lat * Math.PI / 180)) * Math.sin(angle);
          var lat = center.lat + dLat;
          var lng = center.lng + dLng;
          var st = pickSpawnType();
          if (!st) continue;
          dynamicSpawnPoints.push({ type: st.type, lat: lat, lng: lng });
          logDebug(`Spawn generated: ${st.type} at lat=${lat}, lng=${lng}`);
        }
      }
    }

    function updateVisibleSpawns() {
      markersCluster.clearLayers();
      var bounds = map.getBounds();
      dynamicSpawnPoints.forEach((spawn) => {
        var pt = L.latLng(spawn.lat, spawn.lng);
        if (bounds.contains(pt)) {
          var marker = L.marker(pt).bindPopup(`Spawn: ${spawn.type}`);
          markersCluster.addLayer(marker);
          logDebug(`Spawn visible: ${spawn.type} at lat=${spawn.lat}, lng=${spawn.lng}`);
        }
      });
      if (!map.hasLayer(markersCluster)) map.addLayer(markersCluster);
    }

    function onLocationFound(e) {
      var userLatLng = e.latlng;
      logDebug(`User Location: lat=${userLatLng.lat}, lng=${userLatLng.lng}`);
      if (!initialCentered) {
        initialCentered = true;
        map.setView(userLatLng, 16, { animate: false });
        fetch(spawnDataUrl)
          .then(resp => resp.json())
          .then(data => {
            spawnTypes = data.spawnTypes || [];
            logDebug("Spawn data loaded successfully.");
            generateDynamicSpawns(userLatLng);
            updateVisibleSpawns();
          })
          .catch(err => logDebug("Error loading spawn data: " + err.message));
      } else {
        map.setView(userLatLng, 16, { animate: false });
      }
      lastPlayerLatLng = userLatLng;
      if (!map.hasLayer(playerMarker)) {
        playerMarker.addTo(map);
        playerRadiusCircle.addTo(map);
      }
      playerMarker.setLatLng(userLatLng);
      playerRadiusCircle.setLatLng(userLatLng);
      updateVisibleSpawns();
    }

    map.on('locationfound', onLocationFound);
    map.locate({ setView: false, watch: true, maxZoom: 16 });
    map.on('moveend zoomend', updateVisibleSpawns);
  </script>
</body>
</html>
